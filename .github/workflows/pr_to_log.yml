name: Append closed PRs to PR_LOG

on:
  pull_request:
    types: [closed]

permissions:
  contents: write

jobs:
  append-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Append PR block to PR_LOG.md
        uses: actions/github-script@v7
        env:
          LOG_FILE: PR_LOG.md
        with:
          script: |
            const fs = require('fs');

            const logPath = process.env.LOG_FILE || 'PR_LOG.md';
            const pr = context.payload.pull_request;

            const number = pr.number;
            const title = pr.title?.trim() || 'Untitled';
            const author = pr.user?.login || 'unknown';
            const state = pr.merged ? 'merged' : 'closed';
            const created = (pr.created_at || '').slice(0,10);
            const closed = (pr.closed_at || '').slice(0,10);
            const merged = pr.merged_at ? pr.merged_at.slice(0,10) : null;
            const url = pr.html_url;
            const labels = (pr.labels || []).map(l => l.name).join(', ') || 'none';
            const body = (pr.body || '').trim() || '_No description provided._';

            // Idempotence : ne pas dupliquer si déjà loguée
            const marker = `PR #${number} —`;
            if (fs.existsSync(logPath)) {
              const existing = fs.readFileSync(logPath, 'utf8');
              if (existing.includes(marker)) {
                core.info(`PR #${number} already logged, skipping.`);
                return;
              }
            }

            if (!fs.existsSync(logPath)) {
              fs.writeFileSync(logPath, '# PR log\n\n', 'utf8');
            }

            const meta =
              `- PR #${number} — ${state}\n` +
              `- Author: @${author}\n` +
              `- Created: ${created}\n` +
              `- Closed: ${closed}\n` +
              (merged ? `- Merged: ${merged}\n` : '') +
              `- Labels: ${labels}\n` +
              `- URL: ${url}\n`;

            const block =
              `\n---\n\n` +
              `## ${title}\n\n` +
              `${meta}\n` +
              `### Description\n\n` +
              `${body}\n`;

            fs.appendFileSync(logPath, block, 'utf8');

      - name: Commit changes
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add PR_LOG.md
          git commit -m "docs(pr-log): log PR #${{ github.event.pull_request.number }}"
          git push
