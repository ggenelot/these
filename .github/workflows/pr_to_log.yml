name: Log closed PRs to PR_LOG (newest first)

on:
  pull_request:
    types: [closed]

permissions:
  contents: write

jobs:
  log-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Insert PR block at top of PR_LOG.md
        uses: actions/github-script@v7
        env:
          LOG_FILE: PR_LOG.md
        with:
          script: |
            const fs = require('fs');

            const logPath = process.env.LOG_FILE || 'PR_LOG.md';
            const pr = context.payload.pull_request;

            const number = pr.number;
            const title = (pr.title || 'Untitled').trim();
            const author = pr.user?.login || 'unknown';
            const state = pr.merged ? 'merged' : 'closed';
            const created = (pr.created_at || '').slice(0, 10);
            const closed = (pr.closed_at || '').slice(0, 10);
            const merged = pr.merged_at ? pr.merged_at.slice(0, 10) : null;
            const url = pr.html_url;
            const labels = (pr.labels || []).map(l => l.name).join(', ') || 'none';
            const body = (pr.body || '').trim() || '_No description provided._';

            const marker = `PR #${number} —`;

            const header = '# PR log\n\n';
            let existing = fs.existsSync(logPath) ? fs.readFileSync(logPath, 'utf8') : header;

            if (!existing.startsWith('# PR log')) {
              existing = header + existing.trimStart();
            }

            // Idempotence: skip if already logged
            if (existing.includes(marker) || existing.includes(url)) {
              core.info(`PR #${number} already logged, skipping.`);
              return;
            }

            const meta =
              `- PR #${number} — ${state}\n` +
              `- Author: @${author}\n` +
              `- Created: ${created}\n` +
              `- Closed: ${closed}\n` +
              (merged ? `- Merged: ${merged}\n` : '') +
              `- Labels: ${labels}\n` +
              `- URL: ${url}\n`;

            const block =
              `---\n\n` +
              `## ${title}\n\n` +
              `${meta}\n` +
              `### Description\n\n` +
              `${body}\n\n`;

            // Insert just after the header blank line => newest first
            const insertPos = existing.indexOf('\n\n');
            const updated =
              existing.slice(0, insertPos + 2) +
              block +
              existing.slice(insertPos + 2);

            fs.writeFileSync(logPath, updated, 'utf8');

      - name: Commit changes
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add PR_LOG.md
          git commit -m "docs(pr-log): log PR #${{ github.event.pull_request.number }}"
          git push
