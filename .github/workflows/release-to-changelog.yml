name: Sync release notes to CHANGELOG (newest first)

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Insert release notes at top of CHANGELOG.md
        uses: actions/github-script@v7
        env:
          CHANGELOG_FILE: CHANGELOG.md
        with:
          script: |
            const fs = require('fs');

            const changelogPath = process.env.CHANGELOG_FILE || 'CHANGELOG.md';
            const rel = context.payload.release;

            const tag = rel.tag_name;
            const name = (rel.name || tag).trim();
            const body = (rel.body || '').trim();
            const publishedAt = (rel.published_at || '').slice(0, 10); // YYYY-MM-DD

            if (!body) {
              core.warning('Release body is empty; skipping changelog update.');
              return;
            }

            const marker = `## [${tag}]`;

            const header = '# Changelog\n\n';
            let existing = fs.existsSync(changelogPath) ? fs.readFileSync(changelogPath, 'utf8') : header;

            if (!existing.startsWith('# Changelog')) {
              existing = header + existing.trimStart();
            }

            // Idempotence: skip if already present
            if (existing.includes(marker)) {
              core.info(`Changelog already contains ${marker}; skipping.`);
              return;
            }

            const entry =
              `## [${tag}] - ${publishedAt}\n` +
              `### ${name}\n\n` +
              `${body}\n\n` +
              `---\n\n`;

            // Insert just after the header blank line => newest first
            const insertPos = existing.indexOf('\n\n');
            const updated =
              existing.slice(0, insertPos + 2) +
              entry +
              existing.slice(insertPos + 2);

            fs.writeFileSync(changelogPath, updated, 'utf8');

      - name: Commit changes
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "docs(changelog): add release notes for ${{ github.event.release.tag_name }}"
          git push
