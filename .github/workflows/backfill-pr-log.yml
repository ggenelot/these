name: Backfill PR_LOG from existing closed PRs

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  backfill:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate PR_LOG.md (newest first)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const { owner, repo } = context.repo;

            let page = 1;
            const per_page = 100;
            let allPRs = [];

            while (true) {
              const { data } = await github.rest.pulls.list({
                owner,
                repo,
                state: 'closed',
                per_page,
                page
              });
              if (data.length === 0) break;
              allPRs = allPRs.concat(data);
              page++;
            }

            // Sort by closed date DESC (newest first).
            allPRs.sort((a, b) =>
              new Date(b.closed_at) - new Date(a.closed_at)
            );

            let output = '# PR log\n\n';

            for (const pr of allPRs) {
              const { data: details } = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: pr.number
              });

              const state = details.merged_at ? 'merged' : 'closed';
              const headBranch = details.head?.ref || 'unknown';
              const baseBranch = details.base?.ref || 'unknown';
              const milestone = details.milestone?.title || 'none';
              const labels = (details.labels || []).map(l => l.name).join(', ') || 'none';
              const commits = typeof details.commits === 'number' ? details.commits : 'unknown';
              const hasDiffStats =
                typeof details.additions === 'number' &&
                typeof details.deletions === 'number' &&
                typeof details.changed_files === 'number';
              const diffSummary = hasDiffStats
                ? `+${details.additions} / -${details.deletions} across ${details.changed_files} file(s)`
                : 'unavailable';
              const mergedLine = details.merged_at
                ? `- Merged: ${details.merged_at.slice(0,10)}\n`
                : '';

              output +=
                `---\n\n` +
                `## ${details.title}\n\n` +
                `- PR #${details.number} â€” ${state}\n` +
                `- Author: @${details.user?.login}\n` +
                `- Created: ${details.created_at.slice(0,10)}\n` +
                `- Closed: ${details.closed_at.slice(0,10)}\n` +
                mergedLine +
                `- Source branch: ${headBranch}\n` +
                `- Target branch: ${baseBranch}\n` +
                `- Milestone: ${milestone}\n` +
                `- Labels: ${labels}\n` +
                `- Diff summary: ${diffSummary}\n` +
                `- Commits: ${commits}\n` +
                `- URL: ${details.html_url}\n\n` +
                `### Description\n\n` +
                `${details.body || '_No description provided._'}\n\n`;
            }

            fs.writeFileSync('PR_LOG.md', output);

      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add PR_LOG.md
          git commit -m "docs(pr-log): backfill from existing PRs" || exit 0
          git push
