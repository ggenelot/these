name: Backfill CHANGELOG from existing releases

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  backfill:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate CHANGELOG.md (newest first)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { owner, repo } = context.repo;

            let page = 1;
            const per_page = 100;
            let releases = [];

            while (true) {
              const { data } = await github.rest.repos.listReleases({
                owner,
                repo,
                per_page,
                page
              });
              if (data.length === 0) break;
              releases = releases.concat(data);
              page++;
            }

            // Trier par date de publication DESC
            releases.sort((a, b) =>
              new Date(b.published_at) - new Date(a.published_at)
            );

            let output = '# Changelog\n\n';

            for (const rel of releases) {
              output +=
                `## [${rel.tag_name}] - ${rel.published_at.slice(0,10)}\n` +
                `### ${rel.name || rel.tag_name}\n\n` +
                `${rel.body || '_No release notes provided._'}\n\n` +
                `---\n\n`;
            }

            fs.writeFileSync('CHANGELOG.md', output);

      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "docs(changelog): backfill from existing releases" || exit 0
          git push
